# 2026-02-03 - Dia de Correções e Melhorias

## Tarefas Pendentes
- **Fotos do Igor:** Ele disse que mandou fotos pelo WhatsApp para colocar em uma pasta, mas não recebi. Contexto foi perdido na compactação anterior. Preciso perguntar novamente quais fotos e qual pasta.
- **CI/CD GitHub:** Push de correção do ci.yml falhou por falta de escopo `workflow` no PAT. Igor precisa fazer push manual ou ajustar token.

## Correções do Sistema INTEIA

### Bug das Entrevistas (CORRIGIDO)
- **Problema:** Entrevistas só funcionavam com Eleitores
- **Causa:** enum `TipoRespondente` no backend não tinha consultor/magistrado/gestor
- **Fix:** Adicionado todos os tipos ao enum + refatorado frontend

### Bug useSearchParams (CORRIGIDO)
- **Problema:** Ao navegar para entrevistas/nova?tipo=consultor, o tipo era ignorado
- **Causa:** `useSearchParams()` retorna null na primeira renderização do Next.js
- **Fix:** Adicionado useState para preservar o tipo detectado da URL

### Padronização Estrutural (Codex GPT-5.2)
- Componentes genéricos criados
- Exportação (CSV, Excel, PDF, MD) para todos os tipos de agentes
- 4 visualizações padronizadas

## Incidente WhatsApp - Análise e Prevenção

### O que aconteceu
1. 11:45 - Clawdbot detectou inatividade de 30min
2. 11:45 - Tentou reiniciar conexão → falhou com WebSocket error
3. 13:00+ - WhatsApp ficou offline, mensagens não chegavam

### Causa raiz
O mecanismo de auto-reconnect falhou silenciosamente e não alertou/tentou novamente.

### Medidas preventivas implementadas
1. **Cron job `whatsapp-health-check`** - roda a cada 20min
   - Verifica conexão
   - Tenta reconectar automaticamente se detectar problema
   - Alerta Igor se falhar

2. **Script `/root/clawd/scripts/whatsapp_health.sh`**
   - Health check autônomo
   - Pode ser chamado manualmente ou via cron

3. **HEARTBEAT.md atualizado**
   - WhatsApp health check agora é OBRIGATÓRIO em cada heartbeat
   - Não ignorar desconexão

## Lição Aprendida
> "O problema deve ser corrigido na base/origem para não acontecer novamente, não só consertar o erro imediato." - Igor

Aplicação: Não basta reconectar manualmente quando descobrir que WhatsApp caiu. Precisa ter monitoramento proativo + reconexão automática + alertas.

## Codex GPT-5.2 Usado
- Igor pediu explicitamente para usar Codex (não Claude Code)
- Codex rodou padronização estrutural dos módulos de agentes
- Fez 5 commits automaticamente
- Modelo configurado em `~/.codex/config.toml`: `model = "gpt-5.2-codex"`

## Deploy Vercel
- Problema recorrente: "Root Directory frontend does not exist"
- Solução que funcionou: deploy manual via API com `rootDirectory: null` para usar vercel.json do repo
- Deploy final às 13:18 ficou READY

## WhatsApp do Igor
- Número: +5561981157120
- Meu WhatsApp: +5561936181115
- Reconectado às 14:00 via `clawdbot channels login --channel whatsapp`

## 15:44 - Correção Gateway Loop de Restart

### Problema identificado
- Gateway em loop de restart (9000+ restarts/hora)
- Causa: conflito de processos na porta 18789
- Processo órfão mantinha porta ocupada enquanto systemd tentava reiniciar

### Solução implementada
1. **gateway_cleanup.sh** - Script de limpeza pré-start
   - Mata processos órfãos na porta antes de iniciar
   - Aguarda gracefully antes de forçar kill

2. **gateway_health.sh** - Monitoramento proativo
   - Detecta loops de restart (>50/hora)
   - Detecta processos órfãos (systemd=failed + porta ocupada)
   - Corrige automaticamente

3. **HEARTBEAT.md** atualizado
   - Gateway health check agora é PRIMEIRO de todos
   - Roda antes do WhatsApp check

### Causa raiz
WSL + systemd + processos long-running podem deixar processos zumbis.
Quando gateway crashava, processo filho mantinha porta ocupada.
Systemd tentava reiniciar → conflito → loop infinito.

### Prevenção
Scripts de monitoramento detectam e corrigem antes de virar problema.
